---
import { getCollection } from 'astro:content'
import BaseLayout from './BaseLayout.astro'
import Sidebar from '@/components/docs/Sidebar.astro'
import TableOfContents from '@/components/docs/TableOfContents.astro'
import DocsBreadcrumb from '@/components/docs/DocsBreadcrumb.astro'
import DocsSearch from '@/components/docs/DocsSearch'
import type { SearchEntry } from '@/components/docs/DocsSearch'

interface Props {
  title: string
  tagline?: string
  description?: string
  headings: { depth: number; slug: string; text: string }[]
  slug: string
}

const { title, tagline, description, headings, slug } = Astro.props

// Build search index from all docs at build time
let searchIndex: SearchEntry[] = []
try {
  const docs = await getCollection('docs')
  searchIndex = docs.map((entry) => {
    const h1Match = entry.body?.match(/^#\s+(.+)$/m)
    const h1Text = h1Match?.[1] ?? ''
    const dashIdx = h1Text.indexOf(' - ')
    const entryTitle =
      entry.data.title ??
      (dashIdx > -1 ? h1Text.slice(0, dashIdx).trim() : h1Text.trim()) ??
      entry.id
    const entryTagline = dashIdx > -1 ? h1Text.slice(dashIdx + 3) : ''
    const parts = entry.id.split('/')
    const section =
      parts.length > 1
        ? parts[0].replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase())
        : 'Docs'
    return {
      title: entryTitle,
      tagline: entryTagline,
      description: entry.data.description ?? '',
      url: `/docs/${entry.id}`,
      section,
    }
  })
} catch {
  // Collection empty in some dev envs
}
---

<BaseLayout title={title} description={description}>
  <div class="max-w-[88rem] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex gap-8 py-8">
      <!-- Sidebar -->
      <aside class="hidden lg:block w-60 shrink-0">
        <div class="sticky top-20">
          <div class="mb-4">
            <DocsSearch client:load searchIndex={searchIndex} />
          </div>
          <Sidebar currentSlug={slug} />
        </div>
      </aside>

      <!-- Main content -->
      <div class="flex-1 min-w-0" data-pagefind-body>
        <DocsBreadcrumb slug={slug} />
        <!-- Page header: rendered outside prose so it isn't subject to prose h1 hide rule -->
        <div class="mb-6">
          <h1 class="text-4xl lg:text-5xl font-bold text-[#f0f9ff] font-mono tracking-tight leading-none">
            {title}
          </h1>
          {tagline && (
            <p class="text-xl text-[#94a3b8] mt-3 font-normal leading-snug">{tagline}</p>
          )}
        </div>
        <article class="prose prose-invert prose-lg max-w-none">
          <slot />
        </article>
      </div>

      <!-- TOC -->
      {headings.length > 1 && (
        <aside class="hidden xl:block w-52 shrink-0">
          <div class="sticky top-20">
            <TableOfContents headings={headings} />
          </div>
        </aside>
      )}
    </div>
  </div>
</BaseLayout>
