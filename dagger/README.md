# Shipyard Dagger Module

This Dagger module handles building, packaging, and releasing the Shipyard CLI tool across multiple platforms and distribution channels.

## Prerequisites

1. **Install Dagger CLI:**
   ```bash
   curl -L https://dl.dagger.io/dagger/install.sh | sh
   ```

2. **Set up environment variables:**
   ```bash
   export GITHUB_TOKEN="ghp_..."  # GitHub personal access token
   export NPM_TOKEN="npm_..."     # npm access token
   ```

3. **For Docker testing (optional):**
   ```bash
   echo $GITHUB_TOKEN | docker login ghcr.io -u YOUR_USERNAME --password-stdin
   ```

## Usage

All commands should be run from the repository root directory.

### Run Tests

Run all tests with race detection:

```bash
dagger call test --source=.
```

With verbose output:

```bash
dagger call test --source=. --show-output
```

With race detection (uses larger image with CGO):

```bash
dagger call test --source=. --show-output --race
```

### Run Linter

Run golangci-lint:

```bash
dagger call lint --source=.
```

With custom timeout:

```bash
dagger call lint --source=. --timeout=10m
```

### Run Full CI Pipeline

Run tests, lint, and build in sequence:

```bash
dagger call ci --source=.
```

With race detection in tests:

```bash
dagger call ci --source=. --race
```

### Run Coverage

Export coverage file:

```bash
dagger call coverage --source=. export --path=./coverage.out
```

Get coverage report with function breakdown:

```bash
dagger call coverage-report --source=.
```

Check coverage against a threshold (fails if below):

```bash
dagger call coverage-report --source=. --threshold=80
```

### Test Build Stage

Build binaries for all platforms:

```bash
dagger call -m ./dagger build-only --source=. --version=v0.0.0-dev
```

### Test Package Stage

Create distribution archives and checksums:

```bash
dagger call -m ./dagger package-only --source=. --version=v0.0.0-dev export --path=./dist
```

Verify the output:

```bash
ls -lh dist/
tar -tzf dist/shipyard_v0.0.0-dev_darwin_arm64.tar.gz
```

### Test Full Release (Dry Run)

Run the complete release pipeline with a test version:

```bash
dagger call -m ./dagger release \
  --source=. \
  --version=v0.0.0-test \
  --github-token=env:GITHUB_TOKEN \
  --npm-token=env:NPM_TOKEN \
  --docker-registry=ghcr.io/natonathan/shipyard \
  --docker-token=env:GITHUB_TOKEN
```

### Production Release

The release is automatically triggered by GitHub Actions when a version tag is pushed. The workflow calls:

```bash
dagger call -m ./dagger release \
  --source=. \
  --version=$VERSION \
  --github-token=env:GITHUB_TOKEN \
  --npm-token=env:NPM_TOKEN \
  --docker-registry=ghcr.io/natonathan/shipyard \
  --docker-token=env:GITHUB_TOKEN
```

## Architecture

The module provides both CI and release capabilities:

### CI Functions (`ci.go`)

- **Test**: Runs `go test -coverprofile=coverage.out ./...` (optional `--race` flag)
- **Lint**: Installs and runs golangci-lint v2
- **CI**: Runs test, lint, and build in sequence
- **Coverage**: Runs tests and exports `coverage.out` file
- **CoverageReport**: Runs tests and returns coverage percentage with optional threshold check

### Release Pipeline (three stages):

1. **Build Stage** (`build.go`)
   - Cross-compiles for: linux/amd64, linux/arm64, darwin/amd64, darwin/arm64, windows/amd64
   - Uses Go 1.25 with CGO_ENABLED=0 for static binaries
   - Embeds version, commit, and date via ldflags

2. **Package Stage** (`package.go`)
   - Creates tar.gz archives for Unix/macOS
   - Creates zip archives for Windows
   - Generates SHA256 checksums

3. **Publish Stage** (`publish.go`)
   - **GitHub**: Creates release with all artifacts and release notes
   - **Homebrew**: Updates natonathan/homebrew-tap formula
   - **npm**: Publishes shipyard-cli wrapper package
   - **Docker**: Builds and pushes multi-arch images to ghcr.io

All publish operations run in parallel for efficiency.

## Distribution Channels

### GitHub Releases

- Repository: https://github.com/NatoNathan/shipyard/releases
- Contains: Binaries for all platforms, checksums.txt, release notes
- Generated by: Shipyard's own `release-notes` command

### Homebrew Tap

- Repository: https://github.com/natonathan/homebrew-tap
- Install: `brew install natonathan/tap/shipyard`
- Includes: Shell completions via `generate_completions_from_executable`

### npm Package

- Package: https://www.npmjs.com/package/shipyard-cli
- Install: `npm install -g shipyard-cli` or `npx shipyard-cli`
- Binary downloader: Downloads platform-specific binary on postinstall
- Keeps package size < 10KB (binary not bundled)

### Docker Images

- Registry: https://github.com/NatoNathan/shipyard/pkgs/container/shipyard
- Pull: `docker pull ghcr.io/natonathan/shipyard:latest`
- Tags: `latest`, `v1.2.3`, `1.2.3`
- Platforms: linux/amd64, linux/arm64

## Troubleshooting

### Build Failures

Check Go version and dependencies:
```bash
go version  # Should be 1.21+
go mod verify
```

### Package Failures

Verify build artifacts exist:
```bash
dagger call -m ./dagger build-only --source=. --version=test export --path=./build-test
ls -R build-test/
```

### GitHub Release Failures

Check token permissions:
- `contents: write` (for releases)
- `packages: write` (for ghcr.io)

### Homebrew Failures

Ensure checksums are correct:
```bash
sha256sum dist/shipyard_*.tar.gz
```

### npm Failures

Verify token has publish permissions:
```bash
npm whoami --registry=https://registry.npmjs.org
```

### Docker Failures

Check authentication:
```bash
docker login ghcr.io
```

## Development

### Adding a New Platform

1. Add platform to `types.go`:
   ```go
   {OS: "freebsd", Arch: "amd64"},
   ```

2. Test build:
   ```bash
   dagger call -m ./dagger build-only --source=. --version=test
   ```

### Modifying Homebrew Formula

Edit the template in `publish.go` > `generateFormula()`.

### Modifying npm Package

Edit `publish.go` > `createNPMPackage()` and `generateInstallScript()`.

## Migration from GoReleaser

The Dagger pipeline preserves all existing workflows:
- Auto-version system still triggers releases on tags
- Release notes still generated by Shipyard
- Homebrew tap still auto-updates
- GitHub releases still created as drafts then published

New capabilities:
- Docker multi-arch images
- npm package distribution
- Local release testing
- Better parallelization and caching

## Files

- `main.go` - Release orchestrator
- `ci.go` - CI functions (test, lint)
- `build.go` - Cross-platform build stage
- `package.go` - Archive and checksum generation
- `publish.go` - All publishing functions
- `types.go` - Shared types and constants
- `dagger.gen.go` - Auto-generated Dagger types (do not edit)
